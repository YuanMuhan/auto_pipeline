app_name: smart_home_security_automation
version: 1.0
components:
  - id: door_sensor_main
    type: binary_sensor
    capabilities:
      - sense
      - detect_open_close
    metadata:
      layer: device
      description: 主卧门磁传感器
  - id: motion_sensor_living
    type: motion_sensor
    capabilities:
      - sense
      - detect_motion
    metadata:
      layer: device
      description: 客厅人体传感器
  - id: smart_light_living
    type: actuator_light
    capabilities:
      - actuate
    metadata:
      layer: device
      description: 客厅智能灯
  - id: edge_gateway_ha
    type: gateway_homeassistant
    capabilities:
      - collect
      - filter
      - decide
    metadata:
      layer: edge
      description: 边缘网关，负责事件收集、规则处理和本地决策
  - id: cloud_automation_service
    type: server_automation
    capabilities:
      - analyze
      - decide
      - notify
    metadata:
      layer: cloud
      description: 云端自动化服务，负责高级规则、通知和状态管理
  - id: cloud_storage_service
    type: server_database
    capabilities:
      - store
      - aggregate
    metadata:
      layer: cloud
      description: 云端存储服务，负责历史数据存储和查询
links:
  - id: link_door_to_edge
    from: door_sensor_main
    to: edge_gateway_ha
    data_type: sensor_reading
    contract:
      type: object
      properties:
        sensor_id:
          type: string
        state:
          type: string
        timestamp:
          type: string
    frequency: real-time
  - id: link_motion_to_edge
    from: motion_sensor_living
    to: edge_gateway_ha
    data_type: sensor_reading
    contract:
      type: object
      properties:
        sensor_id:
          type: string
        state:
          type: string
        timestamp:
          type: string
    frequency: real-time
  - id: link_edge_to_light
    from: edge_gateway_ha
    to: smart_light_living
    data_type: command
    contract:
      type: object
      properties:
        action:
          type: string
        target:
          type: string
    frequency: on-demand
  - id: link_edge_to_cloud_events
    from: edge_gateway_ha
    to: cloud_automation_service
    data_type: event
    contract:
      type: object
      properties:
        event_type:
          type: string
        payload:
          type: object
        timestamp:
          type: string
    frequency: real-time
  - id: link_edge_to_cloud_storage
    from: edge_gateway_ha
    to: cloud_storage_service
    data_type: sensor_reading
    contract:
      type: object
      properties:
        measurement:
          type: string
        tags:
          type: object
        fields:
          type: object
        timestamp:
          type: string
    frequency: periodic
  - id: link_cloud_automation_to_notify
    from: cloud_automation_service
    to: cloud_automation_service
    data_type: notification
    contract:
      type: object
      properties:
        recipient:
          type: string
        message:
          type: string
        priority:
          type: string
    frequency: on-demand
  - id: link_cloud_automation_to_storage_query
    from: cloud_automation_service
    to: cloud_storage_service
    data_type: query
    contract:
      type: object
      properties:
        query:
          type: string
        parameters:
          type: object
    frequency: on-demand
  - id: link_storage_to_automation_response
    from: cloud_storage_service
    to: cloud_automation_service
    data_type: query_result
    contract:
      type: object
      properties:
        results:
          type: array
    frequency: on-demand
logic:
  modes:
    home_mode:
      description: 在家模式：夜间人体感应开灯
      rules:
        - condition: time_between("22:00", "06:00") AND motion_sensor_living.state == "on"
          action: edge_gateway_ha.send_command(smart_light_living, "turn_on")
        - condition: motion_sensor_living.state == "off" for duration("5m")
          action: edge_gateway_ha.send_command(smart_light_living, "turn_off")
    away_mode:
      description: 离家模式：任何门磁触发均告警
      rules:
        - condition: door_sensor_main.state_changed
          action: cloud_automation_service.send_notification("door_trigger_alert")
        - condition: motion_sensor_living.state == "on"
          action: cloud_automation_service.send_notification("high_priority_motion_alert")
    security_mode:
      description: 安防模式：双重传感器联动
      rules:
        - condition: door_sensor_main.state == "on" AND motion_sensor_living.state == "on"
          action:
            - cloud_automation_service.send_notification("security_breach_alert")
            - cloud_automation_service.trigger_recording
        - condition: consecutive_anomalies > 3
          action: cloud_automation_service.notify_emergency_contact
  fault_handling:
    - condition: sensor_offline(door_sensor_main) OR sensor_offline(motion_sensor_living)
      action: cloud_automation_service.send_notification("sensor_fault")
metadata:
  description: 智能家居安防自动化系统IR
  category: smart_home_automation
  priority: high