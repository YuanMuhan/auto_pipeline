version: '3.8'

services:

  cloud_service:
    image: autopipeline/cloud:latest
    container_name: autopipeline_cloud
    working_dir: /app
    command: python main.py
    environment:
      - LAYER=CLOUD
      - SERVICE_NAME=cloud_service
      - BINDINGS_HASH=148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24
    labels:
      bindings_hash: "148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24"
    volumes:
      - ./generated_code/cloud:/app
    networks:
      - autopipeline_network
    restart: unless-stopped

  edge_service:
    image: autopipeline/edge:latest
    container_name: autopipeline_edge
    working_dir: /app
    command: python main.py
    environment:
      - LAYER=EDGE
      - SERVICE_NAME=edge_service
      - BINDINGS_HASH=148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24
    labels:
      bindings_hash: "148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24"
    volumes:
      - ./generated_code/edge:/app
    networks:
      - autopipeline_network
    restart: unless-stopped

  device_service:
    image: autopipeline/device:latest
    container_name: autopipeline_device
    working_dir: /app
    command: python main.py
    environment:
      - LAYER=DEVICE
      - SERVICE_NAME=device_service
      - BINDINGS_HASH=148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24
    labels:
      bindings_hash: "148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24"
    volumes:
      - ./generated_code/device:/app
    networks:
      - autopipeline_network
    restart: unless-stopped

networks:
  autopipeline_network:
    driver: bridge

# TODO: Add volumes if needed for persistent storage
# volumes:
#   data_volume:

# Transport protocols used:
# - door_state_to_edge: MQTT (QoS: at_least_once)
# - motion_state_to_edge: MQTT (QoS: at_least_once)
# - edge_to_light_control_home: MQTT (QoS: at_least_once)
# - edge_to_cloud_events: HTTP (QoS: best_effort)
# - edge_to_cloud_storage: HTTP (QoS: best_effort)
# - scheduler_to_edge: HTTP (QoS: best_effort)
# - edge_to_security_controller: HTTP (QoS: at_least_once)
# - security_to_notifier: HTTP (QoS: at_least_once)
# - cloud_query_to_storage: HTTP (QoS: best_effort)
# BINDINGS_HASH: 148dc5af947335b8283a13fc8f1612675a14e0216ab90ab7d23274244d456c24
